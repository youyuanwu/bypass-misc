---
# Setup DPDK on VMs
- name: Setup DPDK Environment
  hosts: vm1
  become: true
  
  vars:
    # playbook_dir is tests/e2e/playbooks, go up 3 levels to project root
    project_root: "{{ playbook_dir }}/../../../"
    dpdk_deb_local: "{{ project_root }}/build/dpdk_22.11.11_amd64.deb"
    dpdk_deb_remote: /tmp/dpdk_22.11.11_amd64.deb
    dpdk_version: "22.11.11"

  tasks:
    - name: Get local deb checksum
      ansible.builtin.stat:
        path: "{{ dpdk_deb_local }}"
        checksum_algorithm: md5
      register: local_deb
      delegate_to: localhost
      become: false

    - name: Get remote deb checksum
      ansible.builtin.stat:
        path: "{{ dpdk_deb_remote }}"
        checksum_algorithm: md5
      register: remote_deb

    - name: Determine if deb needs update
      ansible.builtin.set_fact:
        deb_needs_update: "{{ not remote_deb.stat.exists or (remote_deb.stat.checksum != local_deb.stat.checksum) }}"

    - name: Copy DPDK deb to VM (if missing or hash mismatch)
      ansible.builtin.copy:
        src: "{{ dpdk_deb_local }}"
        dest: "{{ dpdk_deb_remote }}"
        mode: '0644'
      when: deb_needs_update

    - name: Install DPDK dependencies
      ansible.builtin.apt:
        name:
          - libnuma1
          - libelf1t64
          - zlib1g
          - libzstd1
          - libatomic1
          - rdma-core
          - libibverbs1
          - libmlx5-1
          - librdmacm1
        state: present
        update_cache: true

    - name: Remove old DPDK package (if deb changed)
      ansible.builtin.apt:
        name: dpdk
        state: absent
        purge: true
      when: deb_needs_update

    - name: Install DPDK from deb
      ansible.builtin.apt:
        deb: "{{ dpdk_deb_remote }}"
        state: present
      when: deb_needs_update

    - name: Update shared library cache
      ansible.builtin.command: ldconfig
      when: deb_needs_update

    - name: Verify DPDK installation
      ansible.builtin.shell: |
        echo "=== DPDK Package Info ==="
        dpkg -l dpdk
        echo ""
        echo "=== DPDK Libraries ==="
        ls -la /usr/local/lib/x86_64-linux-gnu/librte*.so.* 2>/dev/null | head -5 || echo "Libraries in different location"
        echo ""
        echo "=== DPDK Binaries ==="
        ls -la /usr/local/bin/dpdk-* 2>/dev/null | head -5 || echo "No binaries found in /usr/local/bin"
      register: dpdk_info
      changed_when: false

    - name: Display DPDK installation info
      ansible.builtin.debug:
        msg: "{{ dpdk_info.stdout_lines }}"

    - name: Configure hugepages (2MB)
      ansible.builtin.shell: |
        echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
        mkdir -p /mnt/huge
        mount -t hugetlbfs nodev /mnt/huge || true
        echo "Hugepages configured:"
        cat /proc/meminfo | grep Huge
      register: hugepages_result

    - name: Display hugepages info
      ansible.builtin.debug:
        msg: "{{ hugepages_result.stdout_lines }}"
